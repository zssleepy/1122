<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>贺州市金琪矿业环境监测系统v1</title>
    <!-- 外部库的引入 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; }
        body { background: linear-gradient(135deg, #0a1a2a, #0d2b3e); color: #e0e7ff; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        .company-header { background: linear-gradient(to right, #0d5a7e, #0a3a55); color: white; padding: 12px 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border-bottom: 3px solid #4CAF50; display: flex; justify-content: space-between; align-items: center; z-index: 1000; }
        .header-left, .header-right { display: flex; align-items: center; gap: 15px; }
        .header-icon { font-size: 2.2rem; color: #4CAF50; text-shadow: 0 0 15px rgba(76, 175, 80, 0.6); }
        .company-title { font-size: 1.8rem; margin: 0; background: linear-gradient(90deg, #ffffff, #e0f7ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700; letter-spacing: 0.5px; }
        .company-subtitle { font-size: 1.1rem; opacity: 0.85; margin-top: 4px; color: #a8e6ff; font-weight: 300; }
        #app { display: flex; flex: 1; overflow: hidden; position: relative; gap: 20px; padding: 20px; }
        .map-container-wrapper { flex: 1; background: rgba(18, 32, 50, 0.8); border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.5); padding: 15px; display: flex; flex-direction: column; height: calc(100vh - 120px); min-width: 800px; position: relative; }
        #map-container { flex: 1; position: relative; overflow: hidden; border-radius: 8px; border: 1px solid rgba(74, 175, 80, 0.3); background: #0a1a2a; }
        #map { width: 100%; height: 100%; background: #0a1a2a; border-radius: 8px; }
        .data-sidebar { width: 380px; background: rgba(18, 32, 50, 0.92); border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.5); padding: 20px; display: flex; flex-direction: column; height: calc(100vh - 120px); border: 1px solid rgba(74, 175, 80, 0.3); }
        .data-sidebar.empty { align-items: center; justify-content: center; color: #a8e6ff; font-size: 1.1rem; }
        .control-panel { width: 380px; background: rgba(18, 32, 50, 0.92); backdrop-filter: blur(10px); box-shadow: -5px 0 25px rgba(0,0,0,0.4); padding: 20px; overflow-y: auto; position: relative; display: none; border-left: 1px solid rgba(74, 175, 80, 0.3); transition: all 0.3s ease; z-index: 900; }
        .control-panel.active { display: block; }
        .control-panel.collapsed { width: 40px !important; padding: 0 !important; overflow: hidden; }
        .control-panel.collapsed .panel-content { display: none; }
        .control-panel.collapsed .panel-top-buttons { display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 10px 0; height: 100%; }
        .control-panel.collapsed .panel-top-buttons .export-btn { display: none; }
        .control-panel.collapsed .panel-top-buttons .collapse-btn { width: 30px; height: 30px; margin: 5px 0; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: rgba(74, 175, 80, 0.3); }
        .panel-title { font-size: 1.3rem; color: #e0f7ff; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #4CAF50; font-weight: 600; }
        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #b0d0ff; font-size: 0.95rem; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid rgba(74, 175, 80, 0.3); border-radius: 6px; font-size: 0.95rem; background-color: rgba(10, 26, 42, 0.6); color: #e0f7ff; transition: all 0.2s ease; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.8); cursor: pointer; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #4CAF50; box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2); }
        textarea { height: 100px; resize: vertical; }
        button { background: linear-gradient(135deg, #4CAF50, #3d8b40); color: white; border: none; padding: 14px 0; width: 100%; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: all 0.3s; font-weight: 600; letter-spacing: 0.5px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(76, 175, 80, 0.4); }
        button:disabled { background: #445566; cursor: not-allowed; opacity: 0.6; }
        .data-content { flex: 1; overflow-y: auto; padding-right: 10px; }
        .data-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid rgba(74, 175, 80, 0.4); }
        
        /* --- 方案一：美化后的关闭按钮样式 --- */
        .close-btn {
            background: rgba(255, 255, 255, 0.1); /* 半透明背景 */
            color: #a8e6ff; /* 图标颜色与主题文字颜色匹配 */
            border: 1px solid rgba(255, 255, 255, 0.2); /* 轻微的边框 */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: none; /* 移除默认阴影 */
        }

        .close-btn:hover {
            background: #e74c3c; /* 悬停时变红 */
            color: white; /* 图标变白 */
            border-color: transparent;
            transform: scale(1.1) rotate(90deg); /* 放大并旋转 */
            box-shadow: 0 0 15px rgba(231, 76, 60, 0.6); /* 添加红色光晕效果 */
        }
        /* --- 样式修改结束 --- */

        .admin-panel-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .admin-panel-content { background: rgba(15, 30, 45, 0.98); border-radius: 15px; box-shadow: 0 15px 40px rgba(0, 0, 0, 0.8); padding: 35px; width: 480px; max-width: 90%; color: #ecf0f1; backdrop-filter: blur(12px); border: 1px solid rgba(74, 175, 80, 0.4); position: relative; }
        .admin-panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid rgba(230, 126, 34, 0.45); }
        .admin-panel-title { font-size: 1.9rem; color: #e67e22; display: flex; align-items: center; gap: 15px; }
        .map-switcher { display: flex; gap: 10px; background: rgba(20, 40, 60, 0.8); padding: 8px; border-radius: 30px; backdrop-filter: blur(8px); border: 1px solid rgba(74, 175, 80, 0.3); }
        .map-switch-btn { background: rgba(25, 45, 65, 0.7); color: #4ab0d9; border: 1px solid #4ab0d9; padding: 10px 22px; border-radius: 25px; cursor: pointer; transition: all 0.3s ease; font-size: 0.95rem; font-weight: 500; display: flex; align-items: center; gap: 8px; }
        .map-switch-btn.active { background: linear-gradient(135deg, #4ab0d9, #3498db); color: white; box-shadow: 0 0 20px rgba(52, 152, 219, 0.6); border-color: transparent; }
        .map-switch-btn:hover:not(.active) { background: rgba(74, 176, 217, 0.3); }
        .admin-toggle-btn { background: linear-gradient(135deg, #e67e22, #d35400); color: white; border: none; padding: 12px 12px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; font-size: 1.2rem; width: 44px; height: 44px; box-shadow: 0 4px 15px rgba(230, 126, 34, 0.5); }
        .admin-toggle-btn:hover { background: linear-gradient(135deg, #d35400, #e67e22); transform: translateY(-2px) scale(1.05); box-shadow: 0 6px 20px rgba(230, 126, 34, 0.6); }
        .admin-toggle-btn.logged-in { background: linear-gradient(135deg, #27ae60, #2ecc71); box-shadow: 0 4px 15px rgba(46, 204, 113, 0.5); }
        .admin-toggle-btn.logged-in:hover { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .custom-marker { position: absolute; cursor: pointer; transition: all 0.3s ease; filter: drop-shadow(0 4px 10px rgba(0,0,0,0.7)); z-index: 500; }
        .custom-marker:hover, .custom-marker.highlight { transform: scale(1.2); z-index: 1000; }
        .marker-pin { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.6); border: 2px solid white; transition: all 0.3s ease; }
        .marker-label { position: absolute; background: rgba(0, 0, 0, 0.85); color: white; padding: 5px 12px; border-radius: 20px; font-size: 13px; font-weight: bold; white-space: nowrap; top: -12px; left: 32px; min-width: 30px; text-align: center; box-shadow: 0 3px 8px rgba(0,0,0,0.4); }
        #devtools-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0a1a2a; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; color: white; text-align: center; padding: 20px; display: none; }
        .value-info { font-size: 0.85rem; color: #a8e6ff; margin-top: 4px; display: block; }
        .github-config-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(74, 175, 80, 0.3); }
        .github-config-title { font-size: 1.1rem; color: #e0f7ff; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .cloud-sync-btn { background: linear-gradient(135deg, #3498db, #2980b9); display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 0; }
        .sync-status { margin-top: 10px; padding: 8px; border-radius: 6px; text-align: center; font-size: 0.9rem; display: none; }
        .sync-success { background: rgba(46, 204, 113, 0.2); border: 1px solid rgba(46, 204, 113, 0.4); color: #2ecc71; }
        .sync-error { background: rgba(231, 76, 60, 0.2); border: 1px solid rgba(231, 76, 60, 0.4); color: #e74c3c; }
        .sync-loading { background: rgba(52, 152, 219, 0.2); border: 1px solid rgba(52, 152, 219, 0.4); color: #3498db; }
        .last-sync { font-size: 0.8rem; color: #a8e6ff; margin-top: 10px; text-align: center; display: none; }
        .data-table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 0.9rem; }
        .data-table th, .data-table td { padding: 8px 12px; text-align: left; border-bottom: 1px solid rgba(74, 175, 80, 0.2); }
        .data-table th { background: rgba(74, 175, 80, 0.15); color: #4CAF50; font-weight: 600; }
        .data-table tr:hover { background: rgba(74, 175, 80, 0.1); }
        .action-btn { padding: 8px 12px; margin: 4px; font-size: 0.85rem; border-radius: 4px; transition: all 0.2s; }
        .btn-primary { background: linear-gradient(135deg, #3498db, #2980b9); }
        .btn-warning { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .point-item { background: rgba(10, 26, 42, 0.6); border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(74, 175, 80, 0.2); transition: all 0.3s; cursor: pointer; }
        .point-item:hover { background: rgba(74, 175, 80, 0.1); border-color: rgba(74, 175, 80, 0.4); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .point-item strong { color: #4CAF50; font-size: 1.1rem; }
        .toast-message { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.8); color: white; padding: 12px 24px; border-radius: 30px; z-index: 3000; opacity: 0; transition: opacity 0.3s; font-size: 0.95rem; box-shadow: 0 5px 15px rgba(0,0,0,0.3); pointer-events: none; }
        .toast-message.show { opacity: 1; }
        .toast-message.info { border-left: 4px solid #3498db; }
        .toast-message.success { border-left: 4px solid #2ecc71; }
        .toast-message.error { border-left: 4px solid #e74c3c; }
        .location-hint { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.8); color: #fff; padding: 10px 20px; border-radius: 30px; z-index: 1000; display: none; font-size: 0.9rem; box-shadow: 0 4px 15px rgba(0,0,0,0.4); border: 1px solid rgba(74, 175, 80, 0.3); }
        .map-center-container { display: flex; justify-content: center; align-items: center; width: 100%; height: 100%; overflow: auto; }
        .map-image { max-width: 100%; max-height: 100%; object-fit: contain; }
        .tab-buttons { display: flex; margin-bottom: 20px; border-bottom: 1px solid #4CAF50; }
        .tab-button { width: 50%; background: transparent; border: none; padding: 12px; cursor: pointer; color: #a8e6ff; font-size: 1rem; border-radius: 6px 6px 0 0; transition: all 0.3s; }
        .tab-button.active { background: rgba(76, 175, 80, 0.2); color: #fff; border-bottom: 3px solid #4CAF50; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .panel-top-buttons { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; }
        .panel-top-buttons button { width: 30px; height: 30px; padding: 0; background: rgba(74, 175, 80, 0.3); border-radius: 50%; }
        .custom-marker.draggable { cursor: grab; }
        .custom-marker.draggable:active { cursor: grabbing; }
        .drag-hint { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.8); color: #fff; padding: 10px 20px; border-radius: 30px; z-index: 1000; font-size: 0.9rem; box-shadow: 0 4px 15px rgba(0,0,0,0.4); border: 1px solid rgba(74, 175, 80, 0.3); }
    </style>
</head>
<body>
    <div id="devtools-overlay">
        <h1><i class="fas fa-lock"></i> 访问受限</h1>
        <p>为保护系统安全，开发者工具访问已被阻止。如需访问系统功能，请关闭开发者工具并刷新页面。</p>
    </div>

    <header class="company-header">
        <div class="header-left">
            <i class="fas fa-industry header-icon"></i>
            <div>
                <h1 class="company-title">贺州市金琪矿业有限责任公司</h1>
                <p class="company-subtitle">环境监测系统</p>
            </div>
        </div>
        <div class="header-right">
            <div class="map-switcher">
                <button class="map-switch-btn active" id="map233-btn">图A</button>
                <button class="map-switch-btn" id="map666-btn">图B</button>
            </div>
            <button class="admin-toggle-btn" id="admin-toggle-btn" title="管理员登录/登出">
                <i class="fas fa-user-lock"></i>
            </button>
        </div>
    </header>

    <main id="app">
        <div class="map-container-wrapper">
            <div id="map-container">
                <div id="map" class="map-center-container">
                    <img id="map-image" class="map-image" src="233.jpg" alt="地图">
                </div>
                <div class="location-hint" id="location-select-hint">
                    <i class="fas fa-crosshairs"></i> 请点击地图选择点位位置
                </div>
                <div class="drag-hint" id="drag-hint" style="display: none;">
                    <i class="fas fa-arrows-alt"></i> 管理员模式下可以拖动点位调整位置
                </div>
            </div>
        </div>

        <aside class="data-sidebar empty" id="data-sidebar">
            <i class="fas fa-map-marker-alt" style="font-size: 3rem; color: rgba(74, 175, 80, 0.5); margin-bottom: 20px;"></i>
            <p>点击地图上的点位查看详细信息</p>
        </aside>

        <aside class="control-panel" id="control-panel">
            <div class="panel-top-buttons">
                <button class="export-btn" title="导出Excel"><i class="fas fa-file-export"></i></button>
                <button class="collapse-btn" title="收缩面板"><i class="fas fa-chevron-left"></i></button>
            </div>
            <div class="panel-content">
                <div class="tab-container">
                    <div class="tab-buttons">
                        <button class="tab-button active" id="add-tab-button">添加/编辑记录</button>
                        <button class="tab-button" id="manage-tab-button">管理点位</button>
                    </div>
                    <div id="add-tab" class="tab-content active">
                        <h2 class="panel-title">添加/编辑监测数据</h2>
                        <div class="form-group">
                            <label for="select-point-dropdown">选择点位</label>
                            <select id="select-point-dropdown" disabled>
                                <option value="new-point">--- 新建点位 ---</option>
                            </select>
                        </div>
                        <div class="form-group"><label for="point-code">点位编号</label><input type="text" id="point-code" placeholder="例如: W1, W2" disabled></div>
                        <div class="form-group"><label for="point-name">点位名称</label><input type="text" id="point-name" placeholder="例如: 1# xxxx" disabled></div>
                        <div class="form-group"><label for="water-type">水体类型</label><select id="water-type" disabled><option value="surface">地表水</option><option value="ground">地下水</option></select></div>
                        <hr style="border-color: rgba(74, 175, 80, 0.2); margin: 20px 0;">
                        <div class="form-group"><label for="monitoring-date">监测时间</label><input type="date" id="monitoring-date" disabled></div>
                        <div class="form-group"><label for="operator-name">录入人</label><input type="text" id="operator-name" placeholder="输入录入人姓名" disabled></div>
                        <div class="form-group"><label for="point-zinc">锌监测值(mg/L)</label><input type="number" id="point-zinc" step="0.1" placeholder="输入锌监测值" disabled></div>
                        <div class="form-group"><label for="point-manganese">锰监测值(mg/L)</label><input type="text" id="point-manganese" placeholder="输入锰监测值 (可输入 <0.01)" disabled><span class="value-info">可输入数字或"&lt;0.01"格式</span></div>
                        <div class="form-group"><label for="point-notes">现场情况记录</label><textarea id="point-notes" placeholder="记录现场情况..." disabled></textarea></div>
                        <div class="form-group"><button id="start-select-location-btn" class="action-btn btn-warning" style="width: 100%; display: none;"><i class="fas fa-map-marker-alt"></i> 选择地图点位位置</button></div>
                        <button id="save-btn" disabled>保存监测数据</button>
                    </div>
                    <div id="manage-tab" class="tab-content">
                        <h2 class="panel-title">点位管理</h2>
                        <div id="points-container" class="point-list"></div>
                    </div>
                </div>
                <div class="github-config-section">
                    <h3 class="github-config-title"><i class="fab fa-github"></i> GitHub云端存储配置</h3>
                    <div class="form-group"><label for="github-owner">仓库拥有者</label><input type="text" id="github-owner" placeholder="输入GitHub用户名"></div>
                    <div class="form-group"><label for="github-repo">仓库名称</label><input type="text" id="github-repo" placeholder="输入仓库名称"></div>
                    <div class="form-group"><label for="github-file">数据文件名</label><input type="text" id="github-file" value="data.json" placeholder="例如: data.json"></div>
                    <div class="form-group"><label for="github-token">GitHub个人访问令牌</label><input type="password" id="github-token" placeholder="输入GitHub访问令牌"><span class="value-info">需要repo权限（仅管理员使用）</span></div>
                    <button class="cloud-sync-btn" id="save-to-cloud-btn"><i class="fas fa-cloud-upload-alt"></i> 保存数据到云端</button>
                    <button class="cloud-sync-btn" id="load-from-cloud-btn" style="margin-top: 10px; background: linear-gradient(135deg, #1abc9c, #16a085);"><i class="fas fa-cloud-download-alt"></i> 从云端加载数据</button>
                    <div id="sync-status" class="sync-status"></div>
                    <div id="last-sync" class="last-sync"></div>
                </div>
            </div>
        </aside>
    </main>

    <div class="admin-panel-overlay" id="admin-panel-overlay">
        <div class="admin-panel-content">
            <div class="admin-panel-header">
                <h2 class="admin-panel-title"><i class="fas fa-lock"></i> 管理员登录</h2>
                <button class="close-btn" id="admin-panel-close-btn"><i class="fas fa-times"></i></button>
            </div>
            <div class="form-group"><label for="admin-password">管理密码</label><input type="password" id="admin-password" placeholder="请输入管理密码"></div>
            <button id="admin-login-confirm" class="btn-primary"><i class="fas fa-sign-in-alt"></i> 登录验证</button>
        </div>
    </div>

    <div class="toast-message" id="toast-message"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        const ADMIN_PASSWORD = 'kkhhjjj'; 

        const appState = {
            isLoggedIn: false,
            currentMapId: '233',
            allMapsPointsData: { '233': [], '666': [] },
            currentMarker: null, 
            currentMarkerLocation: null,
            selectedPointId: null,
            editingRecordId: null,
            isDragging: false,
            dragOffsetX: 0,
            dragOffsetY: 0,
            dragElement: null,
            dragPointId: null,
            isSelectingLocation: false,
        };

        const mapConfigurations = {
            '233': { imageUrl: '233.jpg', intrinsicWidth: 1776, intrinsicHeight: 907 },
            '666': { imageUrl: '666.jpg', intrinsicWidth: 1920, intrinsicHeight: 1279 }
        };

        const pointIcons = {
            surface: { className: 'custom-marker', html: '<div class="marker-pin" style="background:#4CAF50"><i class="fas fa-water"></i></div><div class="marker-label"></div>', iconAnchor: [16, 32] },
            ground: { className: 'custom-marker', html: '<div class="marker-pin" style="background:#1abc9c"><i class="fas fa-tint"></i></div><div class="marker-label"></div>', iconAnchor: [16, 32] }
        };

        const elements = {
            app: document.getElementById('app'),
            mapContainer: document.getElementById('map-container'),
            mapImage: document.getElementById('map-image'),
            dataSidebar: document.getElementById('data-sidebar'),
            controlPanel: document.getElementById('control-panel'),
            pointsContainer: document.getElementById('points-container'),
            toastMessage: document.getElementById('toast-message'),
            locationSelectHint: document.getElementById('location-select-hint'),
            dragHint: document.getElementById('drag-hint'),
            map233Btn: document.getElementById('map233-btn'),
            map666Btn: document.getElementById('map666-btn'),
            adminToggleBtn: document.getElementById('admin-toggle-btn'),
            adminLoginConfirmBtn: document.getElementById('admin-login-confirm'),
            startSelectLocationBtn: document.getElementById('start-select-location-btn'),
            saveBtn: document.getElementById('save-btn'),
            selectPointDropdown: document.getElementById('select-point-dropdown'),
            pointCode: document.getElementById('point-code'),
            pointName: document.getElementById('point-name'),
            waterType: document.getElementById('water-type'),
            monitoringDate: document.getElementById('monitoring-date'),
            operatorName: document.getElementById('operator-name'),
            pointZinc: document.getElementById('point-zinc'),
            pointManganese: document.getElementById('point-manganese'),
            pointNotes: document.getElementById('point-notes'),
            adminPanelOverlay: document.getElementById('admin-panel-overlay'),
            adminPanelCloseBtn: document.getElementById('admin-panel-close-btn'),
            adminPasswordInput: document.getElementById('admin-password'),
            addTabButton: document.getElementById('add-tab-button'),
            manageTabButton: document.getElementById('manage-tab-button'),
            addTab: document.getElementById('add-tab'),
            manageTab: document.getElementById('manage-tab'),
            saveToCloudBtn: document.getElementById('save-to-cloud-btn'),
            loadFromCloudBtn: document.getElementById('load-from-cloud-btn'),
            syncStatus: document.getElementById('sync-status'),
            lastSync: document.getElementById('last-sync'),
            githubOwner: document.getElementById('github-owner'),
            githubRepo: document.getElementById('github-repo'),
            githubFile: document.getElementById('github-file'),
            githubToken: document.getElementById('github-token'),
            devtoolsOverlay: document.getElementById('devtools-overlay'),
        };

        const showToast = (message, type = 'info') => {
            elements.toastMessage.textContent = message;
            elements.toastMessage.className = `toast-message show ${type}`;
            setTimeout(() => elements.toastMessage.classList.remove('show'), 3000);
        };

        const updateSyncStatus = (message, type) => {
            elements.syncStatus.textContent = message;
            elements.syncStatus.className = `sync-status ${type}`;
            elements.syncStatus.style.display = 'block';
            setTimeout(() => { elements.syncStatus.style.display = 'none'; }, 5000);
        };

        const updateLastSyncTime = () => {
            elements.lastSync.textContent = `最后同步: ${new Date().toLocaleString()}`;
            elements.lastSync.style.display = 'block';
        };

        const parseManganeseInput = (inputValue) => {
            if (!inputValue || inputValue.trim() === '') return null;
            const trimmedValue = inputValue.trim();
            if (trimmedValue.startsWith('<')) return -0.01;
            const num = parseFloat(trimmedValue);
            return isNaN(num) ? 'invalid' : num;
        };

        const formatManganeseForDisplay = (value) => {
            if (value === null || value === undefined) return '未记录';
            if (value === -0.01) return `<span style="color:#FF9800; font-weight: bold;">&lt;0.01</span>`;
            return value;
        };

        const createHistoryEntry = (action, note, operator = '系统') => ({
            id: Date.now(),
            action,
            note,
            timestamp: new Date().toLocaleString(),
            operator: operator,
        });

        const getWaterTypeName = (waterType) => {
            const names = { surface: '地表水', ground: '地下水' };
            return names[waterType] || waterType;
        };

        const base64EncodeUnicode = (str) => btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1)));
        const base64DecodeUnicode = (str) => decodeURIComponent(Array.prototype.map.call(atob(str), (c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));

        function getMapImageActualDimensions() {
            const img = elements.mapImage;
            const container = elements.mapContainer;
            const intrinsicWidth = img.naturalWidth;
            const intrinsicHeight = img.naturalHeight;
            const containerRect = container.getBoundingClientRect();
            const containerWidth = containerRect.width;
            const containerHeight = containerRect.height;

            let displayedWidth, displayedHeight, offsetX, offsetY;
            const containerRatio = containerWidth / containerHeight;
            const imageRatio = intrinsicWidth / intrinsicHeight;

            if (containerRatio > imageRatio) {
                displayedHeight = containerHeight;
                displayedWidth = intrinsicWidth * (displayedHeight / intrinsicHeight);
                offsetX = (containerWidth - displayedWidth) / 2;
                offsetY = 0;
            } else {
                displayedWidth = containerWidth;
                displayedHeight = intrinsicHeight * (displayedWidth / intrinsicHeight);
                offsetX = 0;
                offsetY = (containerHeight - displayedHeight) / 2;
            }
            return { displayedWidth, displayedHeight, offsetX, offsetY };
        }

        function initMap() {
            elements.mapImage.src = mapConfigurations[appState.currentMapId].imageUrl;
            elements.mapImage.onload = renderMarkers;
            if (elements.mapImage.complete) renderMarkers();
        }

        function switchMap(mapId) {
            if (appState.currentMapId === mapId) return;
            appState.currentMapId = mapId;
            elements.map233Btn.classList.toggle('active', mapId === '233');
            elements.map666Btn.classList.toggle('active', mapId === '666');
            initMap();
            closeDataPanel();
            resetAddPointForm();
            refreshPointList();
            populatePointDropdown();
            showToast(`已切换至图 ${mapId === '233' ? 'A' : 'B'}`, 'info');
        }

        function renderMarkers() {
            document.querySelectorAll('.custom-marker:not(.marker-temp)').forEach(marker => marker.remove());
            (appState.allMapsPointsData[appState.currentMapId] || []).forEach(point => createMarker(point));
            elements.dragHint.style.display = appState.isLoggedIn ? 'block' : 'none';
        }

        function createMarker(pointData, isTemp = false) {
            const iconConfig = pointIcons[pointData.waterType || 'surface'];
            let markerElement = document.createElement('div');
            markerElement.className = `${iconConfig.className} ${isTemp ? 'marker-temp' : ''}`;
            markerElement.innerHTML = iconConfig.html;
            markerElement.dataset.pointId = pointData.id;
            markerElement.dataset.waterType = pointData.waterType; 

            const { displayedWidth, displayedHeight, offsetX, offsetY } = getMapImageActualDimensions();
            const mapConfig = mapConfigurations[appState.currentMapId];

            const xPos = offsetX + (pointData.lng / mapConfig.intrinsicWidth) * displayedWidth;
            const yPos = offsetY + (pointData.lat / mapConfig.intrinsicHeight) * displayedHeight;
            
            markerElement.style.position = 'absolute';
            markerElement.style.left = `${xPos - iconConfig.iconAnchor[0]}px`;
            markerElement.style.top = `${yPos - iconConfig.iconAnchor[1]}px`;
            markerElement.querySelector('.marker-label').textContent = pointData.code || pointData.name || '';
            
            elements.mapContainer.appendChild(markerElement);

            if (!isTemp) {
                markerElement.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showPointData(pointData.id);
                });
                if (appState.isLoggedIn) enableMarkerDragging(markerElement, pointData.id);
            }
            return markerElement;
        }

        function enableMarkerDragging(markerElement, pointId) {
            markerElement.removeEventListener('mousedown', handleMarkerMouseDown);
            markerElement.classList.add('draggable');
            markerElement.addEventListener('mousedown', handleMarkerMouseDown);

            function handleMarkerMouseDown(e) {
                if (!appState.isLoggedIn) return;
                e.stopPropagation();
                appState.isDragging = true;
                appState.dragElement = markerElement;
                appState.dragPointId = pointId;
                const markerRect = markerElement.getBoundingClientRect();
                appState.dragOffsetX = e.clientX - markerRect.left;
                appState.dragOffsetY = e.clientY - markerRect.top;
                markerElement.style.zIndex = '10000';
                markerElement.style.opacity = '0.8';
            }
        }

        function handleMapMouseMove(e) {
            if (!appState.isDragging || !appState.dragElement) return;
            e.preventDefault();
            const containerRect = elements.mapContainer.getBoundingClientRect();
            let newLeft = e.clientX - containerRect.left - appState.dragOffsetX;
            let newTop = e.clientY - containerRect.top - appState.dragOffsetY;
            newLeft = Math.max(0, Math.min(newLeft, containerRect.width - appState.dragElement.offsetWidth));
            newTop = Math.max(0, Math.min(newTop, containerRect.height - appState.dragElement.offsetHeight));
            appState.dragElement.style.left = `${newLeft}px`;
            appState.dragElement.style.top = `${newTop}px`;
        }

        function handleMapMouseUp() {
            if (!appState.isDragging || !appState.dragElement) return;
            appState.isDragging = false;
            appState.dragElement.style.zIndex = '500';
            appState.dragElement.style.opacity = '1';
            
            const { displayedWidth, displayedHeight, offsetX, offsetY } = getMapImageActualDimensions();
            const mapConfig = mapConfigurations[appState.currentMapId];
            const markerWaterType = appState.dragElement.dataset.waterType || 'surface';
            const iconConfig = pointIcons[markerWaterType];

            const markerRect = appState.dragElement.getBoundingClientRect();
            const containerRect = elements.mapContainer.getBoundingClientRect();

            const markerXInContainer = (markerRect.left - containerRect.left) + iconConfig.iconAnchor[0];
            const markerYInContainer = (markerRect.top - containerRect.top) + iconConfig.iconAnchor[1];

            const markerXInImage = markerXInContainer - offsetX;
            const markerYInImage = markerYInContainer - offsetY;
            
            const newLng = (markerXInImage / displayedWidth) * mapConfig.intrinsicWidth;
            const newLat = (markerYInImage / displayedHeight) * mapConfig.intrinsicHeight;
            
            const points = appState.allMapsPointsData[appState.currentMapId];
            const pointIndex = points.findIndex(p => p.id === appState.dragPointId);
            
            if (pointIndex !== -1) {
                const point = points[pointIndex];
                point.lat = newLat;
                point.lng = newLng;
                if (!point.history) point.history = [];
                point.history.unshift(createHistoryEntry('更新点位位置', `点位坐标更新为 (${newLat.toFixed(2)}, ${newLng.toFixed(2)})`, '管理员'));
                saveAllPointsData();
                showToast(`点位 "${point.name}" 位置已更新！`, 'success');
            }
            appState.dragElement = null;
            appState.dragPointId = null;
        }

        function showPointData(pointId) {
            const point = (appState.allMapsPointsData[appState.currentMapId] || []).find(p => p.id === pointId);
            if (!point) return;

            appState.selectedPointId = pointId;
            document.querySelectorAll('.custom-marker').forEach(m => m.classList.remove('highlight'));
            document.querySelector(`.custom-marker[data-point-id="${pointId}"]`)?.classList.add('highlight');
            
            const recordsHistory = (point.records || []).slice().reverse().map(record => `
                <tr data-record-id="${record.id}">
                    <td>${record.monitoringDate || record.timestamp.split(' ')[0]}</td>
                    <td>${record.zinc ?? '未记录'}</td>
                    <td>${formatManganeseForDisplay(record.manganese)}</td>
                    <td>${record.notes || '无'}</td>
                    <td>${record.operator || '未知'}</td>
                    <td class="admin-only-cell" style="${appState.isLoggedIn ? '' : 'display: none;'}">
                        <button class="action-btn btn-warning edit-record-btn" data-record-id="${record.id}">编辑</button>
                        <button class="action-btn btn-danger delete-record-btn" data-record-id="${record.id}">删除</button>
                    </td>
                </tr>
            `).join('');

            elements.dataSidebar.innerHTML = `
                <div class="data-content">
                    <div class="data-header">
                        <h3>${point.name} (${point.code || '无编号'})</h3>
                        <button class="close-btn"><i class="fas fa-times"></i></button>
                    </div>
                    <p><strong>水体类型:</strong> ${getWaterTypeName(point.waterType || 'surface')} | <strong>记录数:</strong> ${point.records?.length || 0}</p>
                    <h4 style="margin-top: 20px;">记录历史</h4>
                    <div style="max-height: 380px; overflow-y: auto;">
                        <table class="data-table">
                            <thead><tr><th>监测时间</th><th>锌</th><th>锰</th><th>备注</th><th>录入员</th><th class="admin-only-cell" style="${appState.isLoggedIn ? '' : 'display: none;'}">操作</th></tr></thead>
                            <tbody>${recordsHistory || `<tr><td colspan="6" style="text-align:center;">暂无历史记录</td></tr>`}</tbody>
                        </table>
                    </div>
                </div>`;
            elements.dataSidebar.classList.remove('empty');

            if (appState.isLoggedIn) {
                elements.dataSidebar.querySelectorAll('.edit-record-btn').forEach(btn => btn.addEventListener('click', (e) => editRecord(pointId, parseInt(e.target.dataset.recordId))));
                elements.dataSidebar.querySelectorAll('.delete-record-btn').forEach(btn => btn.addEventListener('click', (e) => deleteRecord(pointId, parseInt(e.target.dataset.recordId))));
            }
        }

        function closeDataPanel() {
            elements.dataSidebar.innerHTML = `
                <i class="fas fa-map-marker-alt" style="font-size: 3rem; color: rgba(74, 175, 80, 0.5); margin-bottom: 20px;"></i>
                <p>点击地图上的点位查看详细信息</p>`;
            elements.dataSidebar.classList.add('empty');
            appState.selectedPointId = null;
            appState.editingRecordId = null;
            document.querySelectorAll('.custom-marker').forEach(marker => marker.classList.remove('highlight'));
            resetAddPointForm();
        }

        function savePointData() {
            if (!appState.isLoggedIn) return showToast('请登录管理员账号。', 'error');

            const pointCode = elements.pointCode.value.trim();
            const pointName = elements.pointName.value.trim();
            const waterType = elements.waterType.value;
            const monitoringDate = elements.monitoringDate.value;
            const operatorName = elements.operatorName.value.trim();
            const zincValue = elements.pointZinc.value ? parseFloat(elements.pointZinc.value) : null;
            const manganeseParsed = parseManganeseInput(elements.pointManganese.value);
            const notes = elements.pointNotes.value;

            if (!pointName || !pointCode) return showToast('点位名称和编号不能为空！', 'error');
            if (!monitoringDate) return showToast('监测时间不能为空！', 'error');
            if (!operatorName) return showToast('录入人姓名不能为空！', 'error');
            if (zincValue !== null && isNaN(zincValue)) return showToast('锌监测值必须是数字！', 'error');
            if (manganeseParsed === 'invalid') return showToast('锰监测值格式错误！', 'error');
            
            const points = appState.allMapsPointsData[appState.currentMapId];
            
            if (appState.selectedPointId) {
                const point = points.find(p => p.id === appState.selectedPointId);
                if (!point) return;
                
                if (points.some(p => p.code === pointCode && p.id !== appState.selectedPointId)) {
                    return showToast('点位编号已存在！', 'error');
                }

                point.name = pointName;
                point.code = pointCode;
                point.waterType = waterType;

                const newRecordData = { 
                    zinc: zincValue, 
                    manganese: manganeseParsed, 
                    notes: notes, 
                    operator: operatorName, 
                    monitoringDate: monitoringDate 
                };

                if (appState.editingRecordId) {
                    const recordIndex = point.records.findIndex(r => r.id === appState.editingRecordId);
                    if (recordIndex !== -1) {
                        point.records[recordIndex] = { ...point.records[recordIndex], ...newRecordData };
                        point.history.unshift(createHistoryEntry('编辑记录', `编辑了记录 ID: ${appState.editingRecordId}`, operatorName));
                        showToast(`点位 "${point.name}" 的记录已更新！`, 'success');
                    }
                } else {
                    if (zincValue !== null || manganeseParsed !== null || notes) {
                        if (!point.records) point.records = [];
                        const fullRecord = { ...newRecordData, id: Date.now(), timestamp: new Date().toLocaleString() };
                        point.records.push(fullRecord);
                        point.history.unshift(createHistoryEntry('添加记录', `添加新监测记录`, operatorName));
                        showToast(`为点位 "${point.name}" 添加了新记录！`, 'success');
                    } else {
                        showToast('点位信息已更新，但未添加新的监测数据。', 'info');
                    }
                }
            } else {
                if (!appState.currentMarkerLocation) return showToast('请先在地图上选择点位位置！', 'error');
                if (points.some(p => p.code === pointCode)) return showToast('点位编号已存在！', 'error');

                const newPoint = {
                    id: Date.now(), mapId: appState.currentMapId, code: pointCode, name: pointName, waterType: waterType,
                    lat: appState.currentMarkerLocation.lat, lng: appState.currentMarkerLocation.lng,
                    timestamp: new Date().toLocaleString(), records: [], history: [createHistoryEntry('创建点位', '新建监测点位', operatorName)]
                };
                if (zincValue !== null || manganeseParsed !== null || notes) {
                    newPoint.records.push({ 
                        id: Date.now(), 
                        zinc: zincValue, 
                        manganese: manganeseParsed, 
                        notes: notes, 
                        timestamp: new Date().toLocaleString(), 
                        operator: operatorName, 
                        monitoringDate: monitoringDate 
                    });
                }
                points.push(newPoint);
                createMarker(newPoint);
                showToast('新点位添加成功！', 'success');
            }

            saveAllPointsData();
            refreshPointList();
            resetAddPointForm();
            renderMarkers();
            if (appState.selectedPointId) showPointData(appState.selectedPointId);
            populatePointDropdown();
        }

        function resetAddPointForm() {
            appState.selectedPointId = null;
            appState.editingRecordId = null;
            elements.selectPointDropdown.value = 'new-point';
            ['pointCode', 'pointName', 'operatorName', 'pointZinc', 'pointManganese', 'pointNotes'].forEach(id => elements[id].value = '');
            elements.monitoringDate.value = new Date().toISOString().split('T')[0];
            elements.waterType.value = 'surface';
            elements.saveBtn.textContent = '保存监测数据';
            elements.startSelectLocationBtn.textContent = '选择地图点位位置';
            if (appState.currentMarker) { appState.currentMarker.remove(); appState.currentMarker = null; }
            appState.currentMarkerLocation = null;
            elements.locationSelectHint.style.display = 'none';
            elements.mapContainer.style.cursor = '';
            appState.isSelectingLocation = false;
            updateUIPermissions();
        }

        function populatePointDropdown() {
            const points = appState.allMapsPointsData[appState.currentMapId] || [];
            elements.selectPointDropdown.innerHTML = '<option value="new-point">--- 新建点位 ---</option>';
            points.sort((a, b) => (a.name || a.code).localeCompare(b.name || b.code)).forEach(point => {
                const option = document.createElement('option');
                option.value = point.id;
                option.textContent = `${point.name} (${point.code})`;
                elements.selectPointDropdown.appendChild(option);
            });
            elements.selectPointDropdown.disabled = !appState.isLoggedIn;
        }

        function handlePointDropdownChange() {
            const selectedId = elements.selectPointDropdown.value;
            if (selectedId === 'new-point') {
                resetAddPointForm();
            } else {
                const pointId = parseInt(selectedId);
                const point = (appState.allMapsPointsData[appState.currentMapId] || []).find(p => p.id === pointId);
                if (point) {
                    appState.selectedPointId = pointId;
                    appState.editingRecordId = null;
                    elements.pointCode.value = point.code;
                    elements.pointName.value = point.name;
                    elements.waterType.value = point.waterType;
                    elements.monitoringDate.value = new Date().toISOString().split('T')[0];
                    elements.operatorName.value = '';
                    elements.pointZinc.value = '';
                    elements.pointManganese.value = '';
                    elements.pointNotes.value = '';
                    elements.saveBtn.textContent = `为 "${point.name}" 添加新记录`;
                    elements.startSelectLocationBtn.textContent = '选择地图点位位置';
                    if (appState.currentMarker) { appState.currentMarker.remove(); appState.currentMarker = null; }
                    appState.currentMarkerLocation = null;
                    elements.locationSelectHint.style.display = 'none';
                    elements.mapContainer.style.cursor = '';
                    appState.isSelectingLocation = false;
                    updateUIPermissions();
                }
            }
        }

        function refreshPointList() {
            const points = appState.allMapsPointsData[appState.currentMapId] || [];
            elements.pointsContainer.innerHTML = points.length === 0 ? '<p style="text-align: center; color: #999;">当前地图暂无点位</p>' : points.map(point => `
                <div class="point-item" data-id="${point.id}">
                    <div><strong>${point.name}</strong> (${point.code})</div>
                    <div style="font-size:0.9rem;color:#b0d0ff">${getWaterTypeName(point.waterType || 'surface')} | 记录: ${point.records?.length || 0}</div>
                    <div style="margin-top: 10px;">
                        <button class="action-btn btn-primary add-record-btn" ${appState.isLoggedIn ? '' : 'disabled'}>添加数据</button>
                        <button class="action-btn btn-warning edit-point-details-btn" ${appState.isLoggedIn ? '' : 'disabled'}>编辑点位</button>
                        <button class="action-btn btn-danger delete-point-btn" ${appState.isLoggedIn ? '' : 'disabled'}>删除点位</button>
                    </div>
                </div>
            `).join('');
        }

        function editRecord(pointId, recordId) {
            if (!appState.isLoggedIn) return showToast('请登录管理员账号。', 'error');
            const point = (appState.allMapsPointsData[appState.currentMapId] || []).find(p => p.id === pointId);
            if (!point || !point.records) return;
            const record = point.records.find(r => r.id === recordId);
            if (!record) return;

            handleTabSwitch('add-tab');
            elements.selectPointDropdown.value = pointId;
            elements.pointCode.value = point.code;
            elements.pointName.value = point.name;
            elements.waterType.value = point.waterType;
            elements.monitoringDate.value = record.monitoringDate || '';
            elements.operatorName.value = record.operator || '';
            elements.pointZinc.value = record.zinc ?? '';
            elements.pointManganese.value = record.manganese === -0.01 ? '<0.01' : (record.manganese ?? '');
            elements.pointNotes.value = record.notes ?? '';

            appState.selectedPointId = pointId;
            appState.editingRecordId = recordId;
            elements.saveBtn.textContent = `更新 "${point.name}" 的记录`;
            elements.startSelectLocationBtn.style.display = 'none';
            
            updateUIPermissions();
            showToast(`正在编辑点位 "${point.name}" 的记录。`, 'info');
        }

        function deleteRecord(pointId, recordId) {
            if (!appState.isLoggedIn) return showToast('请登录管理员账号。', 'error');
            const point = (appState.allMapsPointsData[appState.currentMapId] || []).find(p => p.id === pointId);
            if (!point || !point.records) return;

            if (confirm(`确定要删除这条记录吗？`)) {
                const recordToDelete = point.records.find(r => r.id === recordId);
                point.records = point.records.filter(r => r.id !== recordId);
                point.history.unshift(createHistoryEntry('删除记录', `删除了记录 ID: ${recordId}`, recordToDelete?.operator || '未知'));
                saveAllPointsData();
                showToast('记录已删除。', 'success');
                showPointData(pointId);
            }
        }

        function updateUIPermissions() {
            const isAdmin = appState.isLoggedIn;
            elements.controlPanel.classList.toggle('active', isAdmin);
            elements.adminToggleBtn.classList.toggle('logged-in', isAdmin);
            elements.adminToggleBtn.title = isAdmin ? `管理员 (点击登出)` : '管理员登录';

            elements.addTabButton.disabled = !isAdmin;
            elements.manageTabButton.disabled = !isAdmin;
            elements.saveBtn.disabled = !isAdmin;
            elements.githubOwner.disabled = !isAdmin;
            elements.githubRepo.disabled = !isAdmin;
            elements.githubFile.disabled = !isAdmin;
            elements.githubToken.disabled = !isAdmin;
            elements.saveToCloudBtn.disabled = !isAdmin;
            elements.loadFromCloudBtn.disabled = !isAdmin;
            
            const isEditingRecord = appState.editingRecordId !== null;
            const isAddingNewPoint = elements.selectPointDropdown.value === 'new-point' && appState.selectedPointId === null;

            elements.selectPointDropdown.disabled = !isAdmin || isEditingRecord;
            
            elements.pointCode.disabled = !isAdmin || isEditingRecord || (!isAddingNewPoint && appState.selectedPointId !== null);
            elements.pointName.disabled = !isAdmin || isEditingRecord || (!isAddingNewPoint && appState.selectedPointId !== null);
            elements.waterType.disabled = !isAdmin || isEditingRecord || (!isAddingNewPoint && appState.selectedPointId !== null);

            const recordFields = ['monitoringDate', 'operatorName', 'pointZinc', 'pointManganese', 'pointNotes'];
            recordFields.forEach(id => {
                elements[id].disabled = !isAdmin;
            });
            
            elements.startSelectLocationBtn.style.display = isAdmin && isAddingNewPoint && elements.addTab.classList.contains('active') ? 'block' : 'none';
            elements.dragHint.style.display = isAdmin ? 'block' : 'none';
            
            renderMarkers();
            refreshPointList();
            if (appState.selectedPointId) showPointData(appState.selectedPointId);
            document.querySelectorAll('.admin-only-cell').forEach(cell => cell.style.display = isAdmin ? 'table-cell' : 'none');
        }

        function loadAllPointsData() {
            try {
                const storedData = localStorage.getItem('allMapsPointsData');
                if (storedData) appState.allMapsPointsData = JSON.parse(storedData);
            } catch (e) {
                console.error("加载本地数据失败:", e);
                appState.allMapsPointsData = { '233': [], '666': [] };
            }
        }

        function saveAllPointsData() {
            localStorage.setItem('allMapsPointsData', JSON.stringify(appState.allMapsPointsData));
        }

        async function saveToGitHub() {
            if (!appState.isLoggedIn) return showToast('请登录管理员账号才能保存到云端。', 'error');
            const { githubOwner, githubRepo, githubFile, githubToken } = elements;
            const owner = githubOwner.value.trim(), repo = githubRepo.value.trim(), file = githubFile.value.trim(), token = githubToken.value.trim();
            if (!owner || !repo || !file || !token) return showToast('请填写完整的GitHub配置信息！', 'error');
            updateSyncStatus('正在保存数据到GitHub...', 'sync-loading');
            try {
                let sha = null;
                const getResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${file}`, {
                    headers: { 'Authorization': `token ${token}`, 'User-Agent': 'Mining-Monitoring-System' }
                });
                if (getResponse.ok) sha = (await getResponse.json()).sha;
                else if (getResponse.status !== 404) throw new Error('获取文件信息失败: ' + ((await getResponse.json()).message || getResponse.statusText));
                
                const content = base64EncodeUnicode(JSON.stringify(appState.allMapsPointsData));
                const message = `数据更新 - ${new Date().toLocaleString()}`;
                const putResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${file}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json', 'User-Agent': 'Mining-Monitoring-System' },
                    body: JSON.stringify({ message, content, sha })
                });
                if (!putResponse.ok) throw new Error('保存失败: ' + ((await putResponse.json()).message || putResponse.statusText));
                
                updateSyncStatus('数据已成功保存到GitHub！', 'sync-success');
                updateLastSyncTime();
                showToast('数据已保存到云端！', 'success');
            } catch (error) {
                console.error('保存到GitHub失败:', error);
                updateSyncStatus(`保存失败: ${error.message}`, 'sync-error');
                showToast(`保存失败: ${error.message}`, 'error');
            }
        }

        async function loadFromGitHub() {
            const { githubOwner, githubRepo, githubFile, githubToken } = elements;
            const owner = githubOwner.value.trim(), repo = githubRepo.value.trim(), file = githubFile.value.trim(), token = githubToken.value.trim();
            if (!owner || !repo || !file) return showToast('请填写GitHub仓库信息！', 'error');
            updateSyncStatus('正在从GitHub加载数据...', 'sync-loading');
            try {
                const options = { headers: { 'User-Agent': 'Mining-Monitoring-System' } };
                if (token) options.headers['Authorization'] = `token ${token}`;
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${file}`, options);
                if (!response.ok) throw new Error('加载失败: ' + ((await response.json()).message || response.statusText));
                
                const newData = JSON.parse(base64DecodeUnicode((await response.json()).content));
                if (typeof newData === 'object' && newData['233'] && newData['666']) {
                    appState.allMapsPointsData = newData;
                    saveAllPointsData();
                    renderMarkers();
                    refreshPointList();
                    closeDataPanel();
                    updateSyncStatus('数据加载成功！', 'sync-success');
                    updateLastSyncTime();
                    showToast('数据已从云端加载！', 'success');
                } else {
                    throw new Error('无效的数据格式');
                }
            } catch (error) {
                console.error('从GitHub加载失败:', error);
                updateSyncStatus(`加载失败: ${error.message}`, 'sync-error');
                showToast(`加载失败: ${error.message}`, 'error');
            }
        }

        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            for (const mapId in appState.allMapsPointsData) {
                const points = appState.allMapsPointsData[mapId];
                if (points.length === 0) continue;

                const recordsSheetData = [['地图', '点位名称', '点位编号', '水体类型', '监测时间', '锌监测值(mg/L)', '锰监测值(mg/L)', '备注', '录入员', '纬度', '经度']];
                
                points.forEach(point => {
                    const baseRow = [
                        `平面图 ${mapId === '233' ? 'A' : 'B'}`,
                        point.name, point.code || '', getWaterTypeName(point.waterType || 'surface'),
                        '', '', '', '', '',
                        point.lat ? point.lat.toFixed(2) : '', point.lng ? point.lng.toFixed(2) : ''
                    ];
                    if (!point.records || point.records.length === 0) {
                        recordsSheetData.push(baseRow);
                    } else {
                        point.records.forEach(record => {
                            let manganeseDisplay = record.manganese === -0.01 ? '<0.01' : (record.manganese || '');
                            recordsSheetData.push([
                                baseRow[0], baseRow[1], baseRow[2], baseRow[3],
                                record.monitoringDate || '', record.zinc || '', manganeseDisplay, record.notes || '无', record.operator || '未知',
                                baseRow[9], baseRow[10]
                            ]);
                        });
                    }
                });
                if (recordsSheetData.length > 1) {
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(recordsSheetData), `平面图${mapId === '233' ? 'A' : 'B'}数据`);
                }
            }
            if (wb.SheetNames.length === 0) return showToast('没有数据可以导出。', 'info');
            XLSX.writeFile(wb, "环境监测数据.xlsx");
            showToast('数据已导出为 Excel 文件！', 'info');
        }

        function handleAdminLogin() {
            if (elements.adminPasswordInput.value.trim() !== ADMIN_PASSWORD) return showToast('管理员密码错误！', 'error');
            appState.isLoggedIn = true;
            elements.adminPanelOverlay.style.display = 'none';
            elements.adminPasswordInput.value = '';
            showToast(`欢迎！已进入管理员模式。`, 'success');
            updateUIPermissions();
            populatePointDropdown();
        }

        function handleAdminLogout() {
            appState.isLoggedIn = false;
            closeDataPanel();
            resetAddPointForm();
            updateUIPermissions();
            populatePointDropdown();
            showToast('已安全登出。', 'info');
        }

        function handleMapClickForLocation(e) {
            if (!appState.isLoggedIn || !appState.isSelectingLocation) return;
            const { displayedWidth, displayedHeight, offsetX, offsetY } = getMapImageActualDimensions();
            const mapConfig = mapConfigurations[appState.currentMapId];
            const containerRect = elements.mapContainer.getBoundingClientRect();
            const clickX = e.clientX - containerRect.left;
            const clickY = e.clientY - containerRect.top;

            if (clickX < offsetX || clickX > offsetX + displayedWidth || clickY < offsetY || clickY > offsetY + displayedHeight) {
                return showToast('请在地图图片范围内点击。', 'error');
            }
            if (appState.currentMarker) appState.currentMarker.remove();
            
            appState.currentMarkerLocation = {
                lat: ((clickY - offsetY) / displayedHeight) * mapConfig.intrinsicHeight,
                lng: ((clickX - offsetX) / displayedWidth) * mapConfig.intrinsicWidth,
            };
            const tempPoint = { ...appState.currentMarkerLocation, waterType: elements.waterType.value, code: '新点位', id: 'temp' };
            appState.currentMarker = createMarker(tempPoint, true);
            showToast('已选择地图位置。', 'info');
            elements.locationSelectHint.style.display = 'none';
            elements.mapContainer.style.cursor = '';
            appState.isSelectingLocation = false;
            elements.startSelectLocationBtn.textContent = '重新选择地图点位位置';
        }

        function handleTabSwitch(tabId) {
            if (!appState.isLoggedIn) {
                elements.adminPanelOverlay.style.display = 'flex';
                return showToast('请先登录管理员账号。', 'error');
            }
            if (appState.isSelectingLocation) {
                elements.locationSelectHint.style.display = 'none';
                elements.mapContainer.style.cursor = '';
                appState.isSelectingLocation = false;
                if (appState.currentMarker) { appState.currentMarker.remove(); appState.currentMarker = null; }
            }

            elements.addTab.classList.toggle('active', tabId === 'add-tab');
            elements.manageTab.classList.toggle('active', tabId === 'manage-tab');
            elements.addTabButton.classList.toggle('active', tabId === 'add-tab');
            elements.manageTabButton.classList.toggle('active', tabId === 'manage-tab');

            if (tabId === 'add-tab') {
                resetAddPointForm();
            } else if (tabId === 'manage-tab') {
                refreshPointList();
            }
            updateUIPermissions();
        }

        function handlePointListClick(e) {
            const target = e.target;
            const pointItem = target.closest('.point-item');
            if (!pointItem) return;

            const pointId = parseInt(pointItem.dataset.id);
            const point = (appState.allMapsPointsData[appState.currentMapId] || []).find(p => p.id === pointId);
            if (!point) return;

            if (target.classList.contains('add-record-btn')) {
                handleTabSwitch('add-tab');
                elements.selectPointDropdown.value = pointId;
                handlePointDropdownChange();
                showToast(`为点位 "${point.name}" 准备添加新记录。`, 'info');
            } else if (target.classList.contains('edit-point-details-btn')) {
                handleTabSwitch('add-tab');
                elements.selectPointDropdown.value = pointId;
                appState.selectedPointId = pointId;
                appState.editingRecordId = null;
                elements.pointCode.value = point.code;
                elements.pointName.value = point.name;
                elements.waterType.value = point.waterType;
                elements.monitoringDate.value = new Date().toISOString().split('T')[0];
                elements.operatorName.value = '';
                elements.pointZinc.value = '';
                elements.pointManganese.value = '';
                elements.pointNotes.value = '';
                elements.saveBtn.textContent = `更新点位 "${point.name}" 信息`;
                elements.startSelectLocationBtn.style.display = 'none';
                updateUIPermissions();
                showToast(`正在编辑点位 "${point.name}" 的基本信息。`, 'info');

            } else if (target.classList.contains('delete-point-btn')) {
                if (confirm(`确定要删除点位 "${point.name}" 及其所有记录吗？此操作不可逆！`)) {
                    appState.allMapsPointsData[appState.currentMapId] = (appState.allMapsPointsData[appState.currentMapId] || []).filter(p => p.id !== pointId);
                    saveAllPointsData();
                    renderMarkers();
                    refreshPointList();
                    populatePointDropdown();
                    if (appState.selectedPointId === pointId) closeDataPanel();
                    showToast('点位已删除。', 'success');
                }
            } else {
                showPointData(pointId);
            }
        }
        
        let mapResizeObserver;

        function init() {
            loadAllPointsData();
            initMap();
            updateUIPermissions();
            populatePointDropdown();

            elements.map233Btn.addEventListener('click', () => switchMap('233'));
            elements.map666Btn.addEventListener('click', () => switchMap('666'));
            elements.adminToggleBtn.addEventListener('click', () => appState.isLoggedIn ? handleAdminLogout() : (elements.adminPanelOverlay.style.display = 'flex'));
            elements.adminPanelCloseBtn.addEventListener('click', () => elements.adminPanelOverlay.style.display = 'none');
            elements.adminLoginConfirmBtn.addEventListener('click', handleAdminLogin);
            elements.adminPasswordInput.addEventListener('keypress', e => e.key === 'Enter' && handleAdminLogin());
            elements.saveBtn.addEventListener('click', savePointData);
            elements.startSelectLocationBtn.addEventListener('click', () => {
                appState.isSelectingLocation = true;
                elements.locationSelectHint.style.display = 'block';
                elements.mapContainer.style.cursor = 'crosshair';
                showToast('请点击地图选择点位位置。', 'info');
                if (appState.currentMarker) { appState.currentMarker.remove(); appState.currentMarker = null; }
                elements.startSelectLocationBtn.textContent = '重新选择地图点位位置';
            });
            elements.mapContainer.addEventListener('click', handleMapClickForLocation);
            
            elements.mapContainer.addEventListener('mousemove', handleMapMouseMove);
            document.addEventListener('mouseup', handleMapMouseUp);
            
            elements.addTabButton.addEventListener('click', () => handleTabSwitch('add-tab'));
            elements.manageTabButton.addEventListener('click', () => handleTabSwitch('manage-tab'));
            elements.selectPointDropdown.addEventListener('change', handlePointDropdownChange);

            document.querySelector('.collapse-btn').addEventListener('click', function() {
                const icon = this.querySelector('i');
                elements.controlPanel.classList.toggle('collapsed');
                icon.className = elements.controlPanel.classList.contains('collapsed') ? 'fas fa-chevron-right' : 'fas fa-chevron-left';
            });

            elements.saveToCloudBtn.addEventListener('click', saveToGitHub);
            elements.loadFromCloudBtn.addEventListener('click', loadFromGitHub);
            document.querySelector('.export-btn').addEventListener('click', exportToExcel);
            elements.pointsContainer.addEventListener('click', handlePointListClick);
            elements.dataSidebar.addEventListener('click', e => { 
                const closeButton = e.target.closest('.close-btn');
                if (closeButton) {
                    closeDataPanel();
                }
            });

            mapResizeObserver = new ResizeObserver(entries => {
                for (let entry of entries) {
                    if (entry.target === elements.mapContainer) {
                        renderMarkers();
                        if (appState.currentMarker && appState.currentMarkerLocation) {
                            appState.currentMarker.remove();
                            const tempPoint = { ...appState.currentMarkerLocation, waterType: elements.waterType.value, code: '新点位', id: 'temp' };
                            appState.currentMarker = createMarker(tempPoint, true);
                        }
                    }
                }
            });
            mapResizeObserver.observe(elements.mapContainer);

            const detectDevTools = () => {
                if (window.outerWidth - window.innerWidth > 160 || window.outerHeight - window.innerHeight > 160) {
                    elements.devtoolsOverlay.style.display = 'flex';
                } else {
                    elements.devtoolsOverlay.style.display = 'none';
                }
            };
            window.addEventListener('resize', detectDevTools);
            window.addEventListener('load', detectDevTools);
            document.addEventListener('contextmenu', e => { if (!appState.isLoggedIn) e.preventDefault(); });
        }

        init();
    });
    </script>
</body>
</html>
